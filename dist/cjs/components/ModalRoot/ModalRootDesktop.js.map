{"version":3,"file":"ModalRootDesktop.js","names":["warn","warnOnce","ModalRootDesktopComponent","props","undefined","maskElementRef","React","createRef","modalRootContext","updateModalHeight","registerModal","id","data","Object","assign","getModalState","onClose","onExit","isInsideModal","platform","ANDROID","VKCOM","Children","toArray","children","prevProps","exitingModal","closeModal","enteringModal","enteringState","onEnter","requestAnimationFrame","waitTransitionFinish","onEntered","animateModalOpacity","activeModal","restoreFocusTo","document","activeElement","focus","prevModalState","onExited","setMaskOpacity","modalState","eventHandler","transitionEvent","supported","onceHandler","innerElement","removeEventListener","name","addEventListener","setTimeout","timeout","display","style","transitionDelay","delayEnter","opacity","forceOpacity","history","maskAnimationFrame","cancelAnimationFrame","current","translateY","translateYCurrent","Math","max","min","toString","classNames","getClassName","configProvider","webviewType","WebviewType","VKAPPS","modals","map","Modal","modalId","getNavId","key","Boolean","Component","ModalRootDesktop","withContext","withPlatform","withDOM","withModalManager","ConfigProviderContext"],"sources":["../../../../src/components/ModalRoot/ModalRootDesktop.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { classNames } from \"../../lib/classNames\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { HasPlatform } from \"../../types\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withContext } from \"../../hoc/withContext\";\nimport {\n  ModalRootContext,\n  ModalRootContextInterface,\n} from \"./ModalRootContext\";\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from \"../ConfigProvider/ConfigProviderContext\";\nimport { ModalsStateEntry } from \"./types\";\nimport { ANDROID, VKCOM } from \"../../lib/platform\";\nimport { getClassName } from \"../../helpers/getClassName\";\nimport { DOMProps, withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { ModalTransitionProps, withModalManager } from \"./useModalManager\";\nimport \"./ModalRoot.css\";\n\nconst warn = warnOnce(\"ModalRoot\");\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n  children?: React.ReactNode;\n\n  /**\n   * Будет вызвано при начале открытия активной модалки с её id\n   */\n  onOpen?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном открытии активной модалки с её id\n   */\n  onOpened?(modalId: string): void;\n\n  /**\n   * Будет вызвано при начале закрытия активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном закрытии активной модалки с её id\n   */\n  onClosed?(modalId: string): void;\n}\n\nclass ModalRootDesktopComponent extends React.Component<\n  ModalRootProps & DOMProps & ModalTransitionProps\n> {\n  constructor(props: ModalRootProps & ModalTransitionProps) {\n    super(props);\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: () => undefined,\n      registerModal: ({ id, ...data }) =>\n        Object.assign(this.getModalState(id), data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n  }\n\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private restoreFocusTo: HTMLElement | undefined = undefined;\n\n  private get timeout() {\n    return this.props.platform === ANDROID || this.props.platform === VKCOM\n      ? 320\n      : 400;\n  }\n\n  private get modals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  getModalState(id: string | null) {\n    if (id === null) {\n      return undefined;\n    }\n    return this.props.getModalState(id);\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (\n      this.props.exitingModal &&\n      this.props.exitingModal !== prevProps.exitingModal\n    ) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (\n      this.props.enteringModal &&\n      this.props.enteringModal !== prevProps.enteringModal\n    ) {\n      const { enteringModal } = this.props;\n      const enteringState = this.getModalState(enteringModal);\n      this.props.onEnter();\n      requestAnimationFrame(() => {\n        if (this.props.enteringModal === enteringModal) {\n          this.waitTransitionFinish(enteringState, () =>\n            this.props.onEntered(enteringModal)\n          );\n          this.animateModalOpacity(enteringState, true);\n        }\n      });\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = (this.props.document?.activeElement ??\n        undefined) as HTMLElement | undefined;\n    }\n    if (\n      !this.props.activeModal &&\n      !this.props.exitingModal &&\n      this.restoreFocusTo\n    ) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = undefined;\n    }\n  }\n\n  closeModal(id: string) {\n    const prevModalState = this.getModalState(id);\n    if (!prevModalState) {\n      return;\n    }\n\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    this.animateModalOpacity(prevModalState, false);\n    if (!this.props.activeModal) {\n      this.setMaskOpacity(prevModalState, 0);\n    }\n  }\n\n  waitTransitionFinish(\n    modalState: ModalsStateEntry | undefined,\n    eventHandler: () => void\n  ) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(\n          transitionEvent.name as string,\n          onceHandler\n        );\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(\n        transitionEvent.name as string,\n        onceHandler\n      );\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /* Анимирует сдвиг модалки */\n  animateModalOpacity(\n    modalState: ModalsStateEntry | undefined,\n    display: boolean\n  ) {\n    if (modalState?.innerElement) {\n      modalState.innerElement.style.transitionDelay =\n        display && this.props.delayEnter ? `${this.timeout}ms` : \"\";\n      modalState.innerElement.style.opacity = display ? \"1\" : \"0\";\n    }\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(\n    modalState: ModalsStateEntry,\n    forceOpacity: number | null = null\n  ) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(\n          0,\n          Math.min(100, opacity)\n        ).toString();\n      }\n    });\n  }\n\n  render() {\n    const { exitingModal, activeModal, enteringModal } = this.props;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <ModalRootContext.Provider value={this.modalRootContext}>\n        <div\n          vkuiClass={classNames(\n            getClassName(\"ModalRoot\", this.props.platform),\n            this.props.configProvider?.webviewType === WebviewType.VKAPPS &&\n              \"ModalRoot--vkapps\",\n            \"ModalRoot--desktop\"\n          )}\n        >\n          <div\n            vkuiClass=\"ModalRoot__mask\"\n            ref={this.maskElementRef}\n            onClick={this.props.onExit}\n          />\n          <div vkuiClass=\"ModalRoot__viewport\">\n            {this.modals.map((Modal: React.ReactElement) => {\n              const modalId = getNavId(Modal.props, warn);\n              if (modalId !== activeModal && modalId !== exitingModal) {\n                return null;\n              }\n\n              const key = `modal-${modalId}`;\n\n              return (\n                <FocusTrap\n                  restoreFocus={false}\n                  onClose={this.props.onExit}\n                  timeout={this.timeout}\n                  key={key}\n                  vkuiClass={classNames(\n                    \"ModalRoot__modal\",\n                    !exitingModal &&\n                      !enteringModal &&\n                      modalId === activeModal &&\n                      \"ModalRoot__modal--active\",\n                    modalId === exitingModal && \"ModalRoot__modal--prev\",\n                    Boolean(exitingModal) &&\n                      modalId === activeModal &&\n                      \"ModalRoot__modal--next\"\n                  )}\n                >\n                  {Modal}\n                </FocusTrap>\n              );\n            })}\n          </div>\n        </div>\n      </ModalRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootDesktop = withContext(\n  withPlatform(\n    withDOM<ModalRootProps>(withModalManager()(ModalRootDesktopComponent))\n  ),\n  ConfigProviderContext,\n  \"configProvider\"\n);\n"],"mappings":"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"}