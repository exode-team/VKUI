{"version":3,"sources":["../../../../src/components/ModalRoot/ModalRootDesktop.tsx"],"names":["warn","ModalRootDesktopComponent","props","undefined","maskElementRef","React","createRef","modalRootContext","updateModalHeight","registerModal","id","data","Object","assign","getModalState","onClose","onExit","isInsideModal","platform","ANDROID","VKCOM","Children","toArray","children","prevProps","exitingModal","closeModal","enteringModal","enteringState","onEnter","requestAnimationFrame","waitTransitionFinish","onEntered","animateModalOpacity","activeModal","restoreFocusTo","document","activeElement","focus","prevModalState","onExited","setMaskOpacity","modalState","eventHandler","transitionEvent","supported","onceHandler","innerElement","removeEventListener","name","addEventListener","setTimeout","timeout","display","style","transitionDelay","delayEnter","opacity","forceOpacity","history","maskAnimationFrame","cancelAnimationFrame","current","translateY","translateYCurrent","Math","max","min","toString","configProvider","webviewType","WebviewType","VKAPPS","modals","map","Modal","modalId","key","Boolean","Component","ModalRootDesktop","ConfigProviderContext"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { classNames } from \"../../lib/classNames\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { HasPlatform } from \"../../types\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withContext } from \"../../hoc/withContext\";\nimport {\n  ModalRootContext,\n  ModalRootContextInterface,\n} from \"./ModalRootContext\";\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from \"../ConfigProvider/ConfigProviderContext\";\nimport { ModalsStateEntry } from \"./types\";\nimport { ANDROID, VKCOM } from \"../../lib/platform\";\nimport { getClassName } from \"../../helpers/getClassName\";\nimport { DOMProps, withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { ModalTransitionProps, withModalManager } from \"./useModalManager\";\nimport \"./ModalRoot.css\";\n\nconst warn = warnOnce(\"ModalRoot\");\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n\n  /**\n   * Будет вызвано при начале открытия активной модалки с её id\n   */\n  onOpen?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном открытии активной модалки с её id\n   */\n  onOpened?(modalId: string): void;\n\n  /**\n   * Будет вызвано при начале закрытия активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном закрытии активной модалки с её id\n   */\n  onClosed?(modalId: string): void;\n}\n\nclass ModalRootDesktopComponent extends React.Component<\n  ModalRootProps & DOMProps & ModalTransitionProps\n> {\n  constructor(props: ModalRootProps & ModalTransitionProps) {\n    super(props);\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: () => undefined,\n      registerModal: ({ id, ...data }) =>\n        Object.assign(this.getModalState(id), data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n  }\n\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private restoreFocusTo: HTMLElement | undefined = undefined;\n\n  private get timeout() {\n    return this.props.platform === ANDROID || this.props.platform === VKCOM\n      ? 320\n      : 400;\n  }\n\n  private get modals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  getModalState(id: string | null) {\n    if (id === null) {\n      return undefined;\n    }\n    return this.props.getModalState(id);\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (\n      this.props.exitingModal &&\n      this.props.exitingModal !== prevProps.exitingModal\n    ) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (\n      this.props.enteringModal &&\n      this.props.enteringModal !== prevProps.enteringModal\n    ) {\n      const { enteringModal } = this.props;\n      const enteringState = this.getModalState(enteringModal);\n      this.props.onEnter();\n      requestAnimationFrame(() => {\n        if (this.props.enteringModal === enteringModal) {\n          this.waitTransitionFinish(enteringState, () =>\n            this.props.onEntered(enteringModal)\n          );\n          this.animateModalOpacity(enteringState, true);\n        }\n      });\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = (this.props.document?.activeElement ??\n        undefined) as HTMLElement | undefined;\n    }\n    if (\n      !this.props.activeModal &&\n      !this.props.exitingModal &&\n      this.restoreFocusTo\n    ) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = undefined;\n    }\n  }\n\n  closeModal(id: string) {\n    const prevModalState = this.getModalState(id);\n    if (!prevModalState) {\n      return;\n    }\n\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    this.animateModalOpacity(prevModalState, false);\n    if (!this.props.activeModal) {\n      this.setMaskOpacity(prevModalState, 0);\n    }\n  }\n\n  waitTransitionFinish(\n    modalState: ModalsStateEntry | undefined,\n    eventHandler: () => void\n  ) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(\n          transitionEvent.name as string,\n          onceHandler\n        );\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(\n        transitionEvent.name as string,\n        onceHandler\n      );\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /* Анимирует сдвиг модалки */\n  animateModalOpacity(\n    modalState: ModalsStateEntry | undefined,\n    display: boolean\n  ) {\n    if (modalState?.innerElement) {\n      modalState.innerElement.style.transitionDelay =\n        display && this.props.delayEnter ? `${this.timeout}ms` : \"\";\n      modalState.innerElement.style.opacity = display ? \"1\" : \"0\";\n    }\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(\n    modalState: ModalsStateEntry,\n    forceOpacity: number | null = null\n  ) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(\n          0,\n          Math.min(100, opacity)\n        ).toString();\n      }\n    });\n  }\n\n  render() {\n    const { exitingModal, activeModal, enteringModal } = this.props;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <ModalRootContext.Provider value={this.modalRootContext}>\n        <div\n          // eslint-disable-next-line vkui/no-object-expression-in-arguments\n          vkuiClass={classNames(\n            getClassName(\"ModalRoot\", this.props.platform),\n            {\n              \"ModalRoot--vkapps\":\n                this.props.configProvider?.webviewType === WebviewType.VKAPPS,\n            },\n            \"ModalRoot--desktop\"\n          )}\n        >\n          <div\n            vkuiClass=\"ModalRoot__mask\"\n            ref={this.maskElementRef}\n            onClick={this.props.onExit}\n          />\n          <div vkuiClass=\"ModalRoot__viewport\">\n            {this.modals.map((Modal: React.ReactElement) => {\n              const modalId = getNavId(Modal.props, warn);\n              if (modalId !== activeModal && modalId !== exitingModal) {\n                return null;\n              }\n\n              const key = `modal-${modalId}`;\n\n              return (\n                <FocusTrap\n                  restoreFocus={false}\n                  onClose={this.props.onExit}\n                  timeout={this.timeout}\n                  key={key}\n                  // eslint-disable-next-line vkui/no-object-expression-in-arguments\n                  vkuiClass={classNames(\"ModalRoot__modal\", {\n                    \"ModalRoot__modal--active\":\n                      !exitingModal &&\n                      !enteringModal &&\n                      modalId === activeModal,\n                    \"ModalRoot__modal--prev\": modalId === exitingModal,\n                    \"ModalRoot__modal--next\":\n                      Boolean(exitingModal) && modalId === activeModal,\n                  })}\n                >\n                  {Modal}\n                </FocusTrap>\n              );\n            })}\n          </div>\n        </div>\n      </ModalRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootDesktop = withContext(\n  withPlatform(\n    withDOM<ModalRootProps>(withModalManager()(ModalRootDesktopComponent))\n  ),\n  ConfigProviderContext,\n  \"configProvider\"\n);\n"],"file":"ModalRootDesktop.js"}