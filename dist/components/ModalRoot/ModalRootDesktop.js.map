{"version":3,"file":"ModalRootDesktop.js","names":["React","classNames","transitionEvent","withPlatform","withContext","ModalRootContext","ConfigProviderContext","WebviewType","ANDROID","VKCOM","getClassName","withDOM","getNavId","warnOnce","FocusTrap","withModalManager","warn","ModalRootDesktopComponent","props","undefined","maskElementRef","createRef","modalRootContext","updateModalHeight","registerModal","id","data","Object","assign","getModalState","onClose","onExit","isInsideModal","platform","Children","toArray","children","prevProps","exitingModal","closeModal","enteringModal","enteringState","onEnter","requestAnimationFrame","waitTransitionFinish","onEntered","animateModalOpacity","activeModal","restoreFocusTo","document","activeElement","focus","prevModalState","onExited","setMaskOpacity","modalState","eventHandler","supported","onceHandler","innerElement","removeEventListener","name","addEventListener","setTimeout","timeout","display","style","transitionDelay","delayEnter","opacity","forceOpacity","history","maskAnimationFrame","cancelAnimationFrame","current","translateY","translateYCurrent","Math","max","min","toString","configProvider","webviewType","VKAPPS","modals","map","Modal","modalId","key","Boolean","Component","ModalRootDesktop"],"sources":["../../../src/components/ModalRoot/ModalRootDesktop.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { classNames } from \"../../lib/classNames\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { HasPlatform } from \"../../types\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withContext } from \"../../hoc/withContext\";\nimport {\n  ModalRootContext,\n  ModalRootContextInterface,\n} from \"./ModalRootContext\";\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from \"../ConfigProvider/ConfigProviderContext\";\nimport { ModalsStateEntry } from \"./types\";\nimport { ANDROID, VKCOM } from \"../../lib/platform\";\nimport { getClassName } from \"../../helpers/getClassName\";\nimport { DOMProps, withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { ModalTransitionProps, withModalManager } from \"./useModalManager\";\nimport \"./ModalRoot.css\";\n\nconst warn = warnOnce(\"ModalRoot\");\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n  children?: React.ReactNode;\n\n  /**\n   * Будет вызвано при начале открытия активной модалки с её id\n   */\n  onOpen?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном открытии активной модалки с её id\n   */\n  onOpened?(modalId: string): void;\n\n  /**\n   * Будет вызвано при начале закрытия активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n\n  /**\n   * Будет вызвано при окончательном закрытии активной модалки с её id\n   */\n  onClosed?(modalId: string): void;\n}\n\nclass ModalRootDesktopComponent extends React.Component<\n  ModalRootProps & DOMProps & ModalTransitionProps\n> {\n  constructor(props: ModalRootProps & ModalTransitionProps) {\n    super(props);\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: () => undefined,\n      registerModal: ({ id, ...data }) =>\n        Object.assign(this.getModalState(id), data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n  }\n\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private restoreFocusTo: HTMLElement | undefined = undefined;\n\n  private get timeout() {\n    return this.props.platform === ANDROID || this.props.platform === VKCOM\n      ? 320\n      : 400;\n  }\n\n  private get modals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  getModalState(id: string | null) {\n    if (id === null) {\n      return undefined;\n    }\n    return this.props.getModalState(id);\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (\n      this.props.exitingModal &&\n      this.props.exitingModal !== prevProps.exitingModal\n    ) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (\n      this.props.enteringModal &&\n      this.props.enteringModal !== prevProps.enteringModal\n    ) {\n      const { enteringModal } = this.props;\n      const enteringState = this.getModalState(enteringModal);\n      this.props.onEnter();\n      requestAnimationFrame(() => {\n        if (this.props.enteringModal === enteringModal) {\n          this.waitTransitionFinish(enteringState, () =>\n            this.props.onEntered(enteringModal)\n          );\n          this.animateModalOpacity(enteringState, true);\n        }\n      });\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = (this.props.document?.activeElement ??\n        undefined) as HTMLElement | undefined;\n    }\n    if (\n      !this.props.activeModal &&\n      !this.props.exitingModal &&\n      this.restoreFocusTo\n    ) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = undefined;\n    }\n  }\n\n  closeModal(id: string) {\n    const prevModalState = this.getModalState(id);\n    if (!prevModalState) {\n      return;\n    }\n\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    this.animateModalOpacity(prevModalState, false);\n    if (!this.props.activeModal) {\n      this.setMaskOpacity(prevModalState, 0);\n    }\n  }\n\n  waitTransitionFinish(\n    modalState: ModalsStateEntry | undefined,\n    eventHandler: () => void\n  ) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(\n          transitionEvent.name as string,\n          onceHandler\n        );\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(\n        transitionEvent.name as string,\n        onceHandler\n      );\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /* Анимирует сдвиг модалки */\n  animateModalOpacity(\n    modalState: ModalsStateEntry | undefined,\n    display: boolean\n  ) {\n    if (modalState?.innerElement) {\n      modalState.innerElement.style.transitionDelay =\n        display && this.props.delayEnter ? `${this.timeout}ms` : \"\";\n      modalState.innerElement.style.opacity = display ? \"1\" : \"0\";\n    }\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(\n    modalState: ModalsStateEntry,\n    forceOpacity: number | null = null\n  ) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(\n          0,\n          Math.min(100, opacity)\n        ).toString();\n      }\n    });\n  }\n\n  render() {\n    const { exitingModal, activeModal, enteringModal } = this.props;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <ModalRootContext.Provider value={this.modalRootContext}>\n        <div\n          vkuiClass={classNames(\n            getClassName(\"ModalRoot\", this.props.platform),\n            this.props.configProvider?.webviewType === WebviewType.VKAPPS &&\n              \"ModalRoot--vkapps\",\n            \"ModalRoot--desktop\"\n          )}\n        >\n          <div\n            vkuiClass=\"ModalRoot__mask\"\n            ref={this.maskElementRef}\n            onClick={this.props.onExit}\n          />\n          <div vkuiClass=\"ModalRoot__viewport\">\n            {this.modals.map((Modal: React.ReactElement) => {\n              const modalId = getNavId(Modal.props, warn);\n              if (modalId !== activeModal && modalId !== exitingModal) {\n                return null;\n              }\n\n              const key = `modal-${modalId}`;\n\n              return (\n                <FocusTrap\n                  restoreFocus={false}\n                  onClose={this.props.onExit}\n                  timeout={this.timeout}\n                  key={key}\n                  vkuiClass={classNames(\n                    \"ModalRoot__modal\",\n                    !exitingModal &&\n                      !enteringModal &&\n                      modalId === activeModal &&\n                      \"ModalRoot__modal--active\",\n                    modalId === exitingModal && \"ModalRoot__modal--prev\",\n                    Boolean(exitingModal) &&\n                      modalId === activeModal &&\n                      \"ModalRoot__modal--next\"\n                  )}\n                >\n                  {Modal}\n                </FocusTrap>\n              );\n            })}\n          </div>\n        </div>\n      </ModalRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootDesktop = withContext(\n  withPlatform(\n    withDOM<ModalRootProps>(withModalManager()(ModalRootDesktopComponent))\n  ),\n  ConfigProviderContext,\n  \"configProvider\"\n);\n"],"mappings":"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"}