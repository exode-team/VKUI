{"version":3,"file":"ConfigProvider.js","names":["React","canUseDOM","useDOM","ConfigProviderContext","useIsomorphicLayoutEffect","useObjectMemo","noop","warnOnce","normalizeScheme","Scheme","AppearanceProvider","generateVKUITokensClassName","LocaleProviderContext","warn","useSchemeDetector","node","_scheme","inherit","getScheme","useCallback","undefined","getAttribute","useState","resolvedScheme","setScheme","useEffect","observer","MutationObserver","observe","attributes","attributeFilter","disconnect","deriveAppearance","scheme","SPACE_GRAY","VKCOM_DARK","ConfigProvider","props","parentLocale","useContext","parentConfig","children","webviewType","isWebView","transitionMotionEnabled","platform","hasNewTokens","appearance","locale","normalizedScheme","document","target","body","process","env","NODE_ENV","hasAttribute","setAttribute","removeAttribute","realScheme","derivedAppearance","VKUITokensClassName","classList","add","remove","configContext"],"sources":["../../../src/components/ConfigProvider/ConfigProvider.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { AppearanceType } from \"@vkontakte/vk-bridge\";\nimport { canUseDOM, useDOM } from \"../../lib/dom\";\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n} from \"./ConfigProviderContext\";\nimport { useIsomorphicLayoutEffect } from \"../../lib/useIsomorphicLayoutEffect\";\nimport { useObjectMemo } from \"../../hooks/useObjectMemo\";\nimport { noop } from \"../../lib/utils\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport {\n  normalizeScheme,\n  AppearanceScheme,\n  Scheme,\n} from \"../../helpers/scheme\";\nimport {\n  AppearanceProvider,\n  generateVKUITokensClassName,\n} from \"../AppearanceProvider/AppearanceProvider\";\nimport { LocaleProviderContext } from \"../LocaleProviderContext/LocaleProviderContext\";\n\nexport interface ConfigProviderProps\n  extends Partial<ConfigProviderContextInterface> {\n  /**\n   * @deprecated будет удалено в 5.0.0, устанавливать тему следует через appearance\n   * Цветовая схема приложения\n   */\n  scheme?: AppearanceScheme;\n  /**\n    Локаль ([список](https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry))\n   */\n  locale?: string;\n  children?: React.ReactNode;\n}\n\nconst warn = warnOnce(\"ConfigProvider\");\n\nfunction useSchemeDetector(\n  node: HTMLElement | undefined | null,\n  _scheme: Scheme | \"inherit\"\n) {\n  const inherit = _scheme === \"inherit\";\n  const getScheme = React.useCallback(() => {\n    if (!inherit || !canUseDOM || !node) {\n      return undefined;\n    }\n    return node.getAttribute(\"scheme\") as Scheme;\n  }, [inherit, node]);\n  const [resolvedScheme, setScheme] = React.useState(getScheme());\n\n  React.useEffect(() => {\n    if (!inherit || !node) {\n      return noop;\n    }\n    setScheme(getScheme());\n    const observer = new MutationObserver(() => setScheme(getScheme()));\n    observer.observe(node, { attributes: true, attributeFilter: [\"scheme\"] });\n    return () => observer.disconnect();\n  }, [getScheme, inherit, node]);\n\n  return _scheme === \"inherit\" ? resolvedScheme : _scheme;\n}\n\nconst deriveAppearance = (scheme: Scheme | undefined): AppearanceType =>\n  scheme === Scheme.SPACE_GRAY || scheme === Scheme.VKCOM_DARK\n    ? \"dark\"\n    : \"light\";\n\n/**\n * @see https://vkcom.github.io/VKUI/#/ConfigProvider\n */\nexport const ConfigProvider = (props: ConfigProviderProps) => {\n  const parentLocale = React.useContext(LocaleProviderContext);\n  const parentConfig = React.useContext(ConfigProviderContext);\n\n  const {\n    children,\n    webviewType = parentConfig.webviewType,\n    isWebView = parentConfig.isWebView,\n    transitionMotionEnabled = parentConfig.transitionMotionEnabled,\n    platform = parentConfig.platform,\n    hasNewTokens = parentConfig.hasNewTokens,\n    appearance = parentConfig.appearance,\n    scheme,\n    locale = parentLocale ?? \"ru\",\n  } = props;\n\n  const normalizedScheme = normalizeScheme({\n    scheme,\n    platform,\n    appearance,\n  });\n  const { document } = useDOM();\n  const target = document?.body;\n\n  useIsomorphicLayoutEffect(() => {\n    if (normalizedScheme === \"inherit\") {\n      return noop;\n    }\n    if (\n      process.env.NODE_ENV === \"development\" &&\n      target?.hasAttribute(\"scheme\") &&\n      parentConfig.appearance === undefined // appearance не была вычислена в родительском конфиге, @deprecated будет удалено в 5.0.0\n    ) {\n      warn(\n        '<body scheme> был установлен перед монтированием VKUI - вы не забыли scheme=\"inherit\"?'\n      );\n    }\n    target?.setAttribute(\"scheme\", normalizedScheme);\n    return () => target?.removeAttribute(\"scheme\");\n  }, [normalizedScheme]);\n\n  const realScheme = useSchemeDetector(target, normalizedScheme);\n  const derivedAppearance = deriveAppearance(realScheme);\n\n  useIsomorphicLayoutEffect(() => {\n    const VKUITokensClassName = generateVKUITokensClassName(\n      platform,\n      derivedAppearance\n    );\n\n    // eslint-disable-next-line no-restricted-properties\n    target?.classList.add(VKUITokensClassName);\n\n    return () => {\n      // eslint-disable-next-line no-restricted-properties\n      target?.classList.remove(VKUITokensClassName);\n    };\n  }, [platform, derivedAppearance]);\n\n  const configContext = useObjectMemo({\n    webviewType,\n    isWebView,\n    transitionMotionEnabled,\n    hasNewTokens,\n    platform,\n    scheme,\n    appearance: appearance || derivedAppearance,\n  });\n\n  return (\n    <ConfigProviderContext.Provider value={configContext}>\n      <LocaleProviderContext.Provider value={locale}>\n        <AppearanceProvider appearance={configContext.appearance}>\n          {children}\n        </AppearanceProvider>\n      </LocaleProviderContext.Provider>\n    </ConfigProviderContext.Provider>\n  );\n};\n"],"mappings":"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"}