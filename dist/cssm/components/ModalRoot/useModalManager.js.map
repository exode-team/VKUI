{"version":3,"sources":["../../../../src/components/ModalRoot/useModalManager.tsx"],"names":["React","ModalType","warnOnce","getNavId","useIsomorphicLayoutEffect","noop","isFunction","getModals","children","Children","toArray","warn","modalTransitionReducer","state","action","type","id","activeModal","nextModal","prevModal","exitingModal","history","isBack","Boolean","includes","splice","indexOf","push","enteringModal","useModalManager","onOpen","onOpened","onClose","onClosed","initModal","modalsState","useRef","current","forEach","Modal","modalProps","props","undefined","dynamicContentHeight","settlingHeight","isMissing","safeActiveModal","useReducer","transitionState","dispatchTransition","process","env","NODE_ENV","isCard","CARD","onEntered","useCallback","modalState","onExited","delayEnter","getModalState","onEnter","onExit","withModalManager","Wrapped","WithModalManager","transitionManager"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { ModalsState, ModalsStateEntry, ModalType } from \"./types\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { useIsomorphicLayoutEffect } from \"../../lib/useIsomorphicLayoutEffect\";\nimport { noop, isFunction } from \"../../lib/utils\";\n\ninterface ModalTransitionState {\n  activeModal?: string | null;\n  enteringModal?: string | null;\n  exitingModal?: string | null;\n\n  history?: string[];\n  isBack?: boolean | null;\n}\n\nexport interface ModalTransitionProps extends ModalTransitionState {\n  onEnter: VoidFunction;\n  onEntered: (id: string | null) => void;\n  onExit: VoidFunction;\n  onExited: (id: string | null) => void;\n  getModalState: (id: string) => ModalsStateEntry;\n  delayEnter: boolean;\n}\n\nfunction getModals(children: React.ReactNode | React.ReactNode[]) {\n  return React.Children.toArray(children) as React.ReactElement[];\n}\n\nconst warn = warnOnce(\"ModalRoot\");\n\nexport function modalTransitionReducer(\n  state: ModalTransitionState,\n  action: {\n    type: \"setActive\" | \"entered\" | \"exited\" | \"inited\";\n    id: string | null;\n  }\n): ModalTransitionState {\n  if (action.type === \"setActive\" && action.id !== state.activeModal) {\n    const nextModal = action.id;\n    // preserve exiting modal if switching mid-transition\n    const prevModal = state.exitingModal || state.activeModal;\n    let history = state.history ? [...state.history] : [];\n    const isBack = Boolean(nextModal && history.includes(nextModal));\n\n    if (nextModal === null) {\n      history = [];\n    } else if (isBack) {\n      history = history.splice(0, history.indexOf(nextModal) + 1);\n    } else {\n      history.push(nextModal);\n    }\n\n    return {\n      activeModal: nextModal,\n      // not entering yet\n      enteringModal: null,\n      exitingModal: prevModal,\n      history,\n      isBack,\n    };\n  }\n  if (action.type === \"entered\" && action.id === state.enteringModal) {\n    return { ...state, enteringModal: null };\n  }\n  if (action.type === \"exited\" && action.id === state.exitingModal) {\n    return { ...state, exitingModal: null };\n  }\n  if (action.type === \"inited\" && action.id === state.activeModal) {\n    return { ...state, enteringModal: action.id };\n  }\n  return state;\n}\n\n/**\n * Реализует переход модалок. При смене activeModal m1 -> m2:\n * 1. activeModal: m1, exitingModal: null, enteringModal: null, триггер перехода\n * 2. activeModal: m2, exitingModal: m1, enteringModal: null, рендерим m2 чтобы прошел init, начинаем анимацию выхода\n * одновременный переход между ModalPage:\n *   3a. activeModal: m2, exitingModal: m1, enteringModal: m2\n *   4a. exitingModal и enteringModal переходят в null в порядке завершения анимации\n * ИЛИ дожидаемся скрытия ModalCard\n *   3b. activeModal: m2, exitingModal: null, enteringModal: m2\n *   4b. enteringModal переходит в null после завершения анимации\n * 5. activeModal: m2, exitingModal: null, enteringModal: null, переход закончен\n */\nexport function useModalManager(\n  activeModal: string | null | undefined,\n  children: React.ReactNode | React.ReactNode[],\n  onOpen: (id: string) => void = noop,\n  onOpened: (id: string) => void = noop,\n  onClose: (id: string) => void = noop,\n  onClosed: (id: string) => void = noop,\n  initModal: (state: ModalsStateEntry) => void = noop\n): ModalTransitionProps {\n  const modalsState = React.useRef<ModalsState>({}).current;\n  getModals(children).forEach((Modal) => {\n    const modalProps = Modal.props;\n    const id = getNavId(modalProps, warn);\n    const state: ModalsStateEntry = (id !== undefined && modalsState[id]) || {\n      id: id ?? null,\n    };\n\n    state.onOpen = Modal.props.onOpen;\n    state.onOpened = Modal.props.onOpened;\n    state.onClose = Modal.props.onClose;\n    state.onClosed = Modal.props.onClosed;\n    state.dynamicContentHeight = !!modalProps.dynamicContentHeight;\n    // ModalPage props\n    if (typeof modalProps.settlingHeight === \"number\") {\n      state.settlingHeight = modalProps.settlingHeight;\n    }\n\n    if (state.id !== null) {\n      modalsState[state.id] = state;\n    }\n  });\n\n  const isMissing = activeModal && !modalsState[activeModal];\n  const safeActiveModal = isMissing ? null : activeModal;\n  const [transitionState, dispatchTransition] = React.useReducer(\n    modalTransitionReducer,\n    {\n      activeModal: safeActiveModal,\n      enteringModal: null,\n      exitingModal: null,\n      history: safeActiveModal ? [safeActiveModal] : [],\n      isBack: false,\n    }\n  );\n\n  // Map props to state, render activeModal for init\n  useIsomorphicLayoutEffect(() => {\n    // ignore non-existent activeModal\n    if (process.env.NODE_ENV === \"development\" && isMissing) {\n      warn(\n        `Переход невозможен - модальное окно (страница) ${activeModal} не существует`,\n        \"error\"\n      );\n    }\n    dispatchTransition({ type: \"setActive\", id: safeActiveModal ?? null });\n  }, [activeModal]);\n\n  // Init activeModal & set enteringModal\n  useIsomorphicLayoutEffect(() => {\n    if (transitionState.activeModal) {\n      initModal(modalsState[transitionState.activeModal]);\n      dispatchTransition({ type: \"inited\", id: transitionState.activeModal });\n    }\n  }, [transitionState.activeModal]);\n\n  const isCard = (id: string | null | undefined) =>\n    id != null && modalsState[id]?.type === ModalType.CARD;\n  const onEntered = React.useCallback(\n    (id: string | null) => {\n      if (id) {\n        const modalState = modalsState[id];\n\n        if (isFunction(modalState.onOpened)) {\n          modalState.onOpened();\n        } else if (isFunction(onOpened)) {\n          onOpened(id);\n        }\n      }\n\n      dispatchTransition({ type: \"entered\", id });\n    },\n    [modalsState, onOpened]\n  );\n  const onExited = React.useCallback(\n    (id: string | null) => {\n      if (id) {\n        const modalState = modalsState[id];\n\n        if (isFunction(modalState.onClosed)) {\n          modalState.onClosed();\n        } else if (isFunction(onClosed)) {\n          onClosed(id);\n        }\n      }\n\n      dispatchTransition({ type: \"exited\", id });\n    },\n    [modalsState, onClosed]\n  );\n  const delayEnter = Boolean(\n    transitionState.exitingModal &&\n      (isCard(activeModal) || isCard(transitionState.exitingModal))\n  );\n  const getModalState = React.useCallback(\n    (id: string) => modalsState[id],\n    [modalsState]\n  );\n\n  function onEnter() {\n    const modalState =\n      transitionState.activeModal && modalsState[transitionState.activeModal];\n    if (modalState) {\n      if (isFunction(modalState.onOpen)) {\n        modalState.onOpen();\n      } else if (isFunction(onOpen)) {\n        onOpen(modalState.id);\n      }\n    }\n  }\n\n  function onExit() {\n    const modalState =\n      transitionState.activeModal && modalsState[transitionState.activeModal];\n    if (modalState) {\n      if (isFunction(modalState.onClose)) {\n        modalState.onClose();\n      } else if (isFunction(onClose)) {\n        onClose(modalState.id);\n      }\n    }\n  }\n\n  return {\n    onEnter,\n    onEntered,\n    onExit,\n    onExited,\n    ...transitionState,\n    delayEnter,\n    getModalState,\n  };\n}\n\nexport function withModalManager(\n  initModal: (a: ModalsStateEntry) => void = noop\n) {\n  return function <Props extends ModalTransitionProps>(\n    Wrapped: React.ComponentType<Props>\n  ): React.FC<\n    Omit<Props, keyof ModalTransitionProps> & { activeModal?: string | null }\n  > {\n    return function WithModalManager(props) {\n      const transitionManager = useModalManager(\n        props.activeModal,\n        props.children,\n        (props as any).onOpen,\n        (props as any).onOpened,\n        (props as any).onClose,\n        (props as any).onClosed,\n        initModal\n      );\n      return <Wrapped {...(props as any)} {...transitionManager} />;\n    };\n  };\n}\n"],"file":"useModalManager.js"}